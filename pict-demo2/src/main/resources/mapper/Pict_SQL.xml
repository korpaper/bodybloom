<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pict.mapper.PictMapper">
	
	<!-- 스케쥴관리 -->
	<select id="schedule_list" resultType="pictVO">
        WITH RECURSIVE times AS (
            SELECT 1 AS t
            UNION ALL
            <![CDATA[ SELECT t + 1 FROM times WHERE t < 17]]>
        ),
        dates AS (
            SELECT DATE(#{targetdate}) + INTERVAL n DAY AS d
            FROM (
                SELECT 0 n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
            ) x
        )
        SELECT
            t.t AS targettime,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 0) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day1,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 1) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day2,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 2) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day3,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 3) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day4,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 4) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day5,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 5) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day6,
            MAX(CASE WHEN s.targetdate = (SELECT d FROM dates LIMIT 1 OFFSET 6) THEN CONCAT('O', IF(s.title IS NOT NULL AND s.title != '', CONCAT(' (', s.title, ')'), '')) ELSE '' END) AS day7
        FROM times t
        LEFT JOIN schedule_table s ON s.targettime = t.t
        <if test="userid != null and userid != '' ">
             AND s.userid = #{userid}
        </if>
        <if test="targetdate != null and targetdate != '' ">
            AND s.targetdate BETWEEN #{targetdate} AND DATE(#{targetdate}) + INTERVAL 6 DAY
        </if>
        GROUP BY t.t
        ORDER BY t.t
	</select>

    <select id="schedule_list_day" resultType="pictVO">
        WITH RECURSIVE times AS (
            SELECT 1 AS t
            UNION ALL
             <![CDATA[ SELECT t + 1 FROM times WHERE t < 17]]>
        )

        SELECT t.t AS targettime,
        MAX(CASE WHEN s.targetdate = #{targetdate} THEN CONCAT('O ', IFNULL(s.title, '')) ELSE '' END) AS day1
        FROM times t
        LEFT JOIN schedule_table s ON s.targettime = t.t
        <if test="userid != null and userid != '' ">
            AND s.userid = #{userid}
        </if>
        <if test="targetdate != null and targetdate != '' ">
            AND s.targetdate = #{targetdate}
        </if>
        GROUP BY t.t
        ORDER BY t.t;
    </select>
	
	<select id="schedule_list_one" resultType="pictVO">
		select *
		from schedule_table
		where idx = #{idx}
	</select>
	
	<insert id="schedule_insert" parameterType="pictVO">
		INSERT INTO schedule_table
			(
                userid, targetdate, targettime, title
			)
		VALUES (
			 #{userid}, #{targetdate}, #{targettime}, #{title}
			  ) 
	</insert>
	
	<update id="schedule_update" parameterType="pictVO">
		update schedule_table
		set userid =#{userid}, targetdate = #{targetdate}, targettime = #{targettime}, title = #{title}
		where idx = #{idx}
	</update>
	
	<delete id="schedule_delete" parameterType="pictVO">
		delete from schedule_table where idx = #{idx}
	</delete>

    <select id="selectScheduleCount" resultType="int">
        SELECT COUNT(*)
        FROM schedule_table
        WHERE targetdate = #{targetdate}
        AND targettime = #{targettime}
        AND userid = #{userid}
    </select>





    <!-- 오늘의 운동법 -->
    <select id="today_list" resultType="pictVO">
        select *
        from video_table
        <if test="search_text != null and search_text != '' ">
            where (
            title LIKE CONCAT('%', #{search_text}, '%')
            )
        </if>
    </select>

    <select id="today_list_one" resultType="pictVO">
        select *
        from video_table
        where idx = #{idx}
    </select>

    <insert id="today_insert" parameterType="pictVO">
        INSERT INTO video_table
        (
            title, imgurl, videourl, regdate, text
        )
        VALUES (
           #{title}, #{imgurl}, #{videourl}, now(), #{text}
        )
    </insert>

    <update id="today_update" parameterType="pictVO">
        update video_table
        set title =#{title}, videourl = #{videourl}, text = #{text}
        <if test="imgurl != null and imgurl != '' ">
            , imgurl = #{imgurl}
        </if>
        where idx = #{idx}
    </update>

    <delete id="today_delete" parameterType="pictVO">
        delete from video_table where idx = #{idx}
    </delete>


    <!-- 후기 관리 -->
    <select id="review_list" resultType="pictVO">
        select idx, name, title, text
        from review_table
        <if test="search_text != null and search_text != '' ">
            where (
            title LIKE CONCAT('%', #{search_text}, '%') or
            text LIKE CONCAT('%', #{search_text}, '%')
            )
        </if>
    </select>

    <select id="review_list_one" resultType="pictVO">
        select idx, name, title, text
        from review_table
        where idx = #{idx}
    </select>

    <insert id="review_insert" parameterType="pictVO">
        INSERT INTO review_table
        (
            name, title, text
        )
        VALUES (
           #{name}, #{title}, #{text}
        )
    </insert>

    <update id="review_update" parameterType="pictVO">
        update review_table
        set name =#{name}, title = #{title}, text = #{text}
        where idx = #{idx}
    </update>

    <delete id="review_delete" parameterType="pictVO">
        delete from review_table where idx = #{idx}
    </delete>



    <!-- 팝업 관리 -->
    <select id="popup_list" resultType="pictVO">
        select *
        from popup_table
        <if test="search_text != null and search_text != '' ">
            where (
            title LIKE CONCAT('%', #{search_text}, '%')
            )
        </if>
    </select>

    <select id="popup_list_one" resultType="pictVO">
        select *
        from popup_table
        where idx = #{idx}
    </select>

    <insert id="popup_insert" parameterType="pictVO">
        INSERT INTO popup_table
        (
            title, imgurl, linkurl, regdate
        )
        VALUES (
                   #{title}, #{imgurl}, #{linkurl}, now()
               )
    </insert>

    <update id="popup_update" parameterType="pictVO">
        update popup_table
        set title =#{title}, linkurl = #{linkurl}
        <if test="imgurl != null and imgurl != '' ">
            , imgurl = #{imgurl}
        </if>
        where idx = #{idx}
    </update>

    <delete id="popup_delete" parameterType="pictVO">
        delete from popup_table where idx = #{idx}
    </delete>


    <insert id="user_insert" parameterType="adminVO">
        INSERT INTO user_info
        (
            id, password, name, mobile, reg_date, use_at
        )
        VALUES (
           #{id}, #{password}, #{name}, #{mobile}, now(), 'Y'
       )
    </insert>


</mapper>
